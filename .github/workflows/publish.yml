name: Publish to Thunderstore

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish'
        required: true
        type: string
      publish_main:
        description: 'Publish core modpack'
        required: false
        type: boolean
        default: false
      publish_cosmetics:
        description: 'Publish cosmetics pack'
        required: false
        type: boolean
        default: false
      publish_moons:
        description: 'Publish moons pack'
        required: false
        type: boolean
        default: false
      publish_posters:
        description: 'Publish posters pack'
        required: false
        type: boolean
        default: false
      publish_logo:
        description: 'Publish logo pack'
        required: false
        type: boolean
        default: false
      publish_modpack:
        description: 'Publish MoreBrutalLethalCompanyPlus'
        required: true
        type: boolean
        default: true

env:
  GAME_NAME: lethalcompany
  NAMESPACE: seechela

jobs:
  preparation:
    name: Prepare Metadata
    runs-on: ubuntu-latest
    outputs:
      categories: ${{ steps.categories.outputs.list }}
      dependencies: ${{ steps.dependencies.outputs.list }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read categories
        id: categories
        run: |
          CATEGORIES=$(cat categories.txt)
          echo "list<<EOF" >> $GITHUB_OUTPUT
          echo "$CATEGORIES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Read dependencies
        id: dependencies
        run: |
          DEPS=$(tr '\n' ',' < dependencies.txt | sed 's/,$//')
          echo "list=$DEPS" >> $GITHUB_OUTPUT

  publish-main-core:
    name: Publish Core Pack
    if: ${{ github.event.inputs.publish_main == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Upload to Thunderstore
        uses: GreenTF/upload-thunderstore-package@v4.3
        with:
          community: ${{ env.GAME_NAME }}
          namespace: ${{ env.NAMESPACE }}
          name: MoreBrutalLCMain
          version: ${{ github.event.inputs.version }}
          description: "Contains all core mods for MoreBrutalLethalCompanyPlus. MoreBrutalLethalCompanyPlus is required!"
          token: ${{ secrets.Automatic_Publish }}
          categories: |
            Mods
            Modpacks
          file: packs/BrutalLCMain

      - name: Wait for upload completion
        run: |
          echo "‚è≥ Waiting 10 seconds to ensure upload is complete..."
          sleep 10
          echo "‚úÖ Upload wait complete"

  publish-cosmetics:
    name: Publish Cosmetics Pack
    if: ${{ github.event.inputs.publish_cosmetics == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Upload to Thunderstore
        uses: GreenTF/upload-thunderstore-package@v4.3
        with:
          community: ${{ env.GAME_NAME }}
          namespace: ${{ env.NAMESPACE }}
          name: MoreBrutalLCCosmetics
          version: ${{ github.event.inputs.version }}
          description: "Contains all modded cosmetics for MoreBrutalLethalCompanyPlus! MoreBrutalLethalCompanyPlus is required!"
          token: ${{ secrets.Automatic_Publish }}
          categories: |
            Cosmetics
            Suits
            Modpacks
          file: packs/BrutalLCCosmetics

      - name: Wait for upload completion
        run: |
          echo "‚è≥ Waiting 10 seconds to ensure upload is complete..."
          sleep 10
          echo "‚úÖ Upload wait complete"

  publish-moons:
    name: Publish Moons Pack
    if: ${{ github.event.inputs.publish_moons == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Upload to Thunderstore
        uses: GreenTF/upload-thunderstore-package@v4.3
        with:
          community: ${{ env.GAME_NAME }}
          namespace: ${{ env.NAMESPACE }}
          name: MoreBrutalLCMoons
          version: ${{ github.event.inputs.version }}
          description: "Contains all modded moons for MoreBrutalLethalCompanyPlus! MoreBrutalLethalCompanyPlus is required!"
          token: ${{ secrets.Automatic_Publish }}
          categories: |
            Mods
            Moons
            Modpacks
          file: packs/BrutalLCMoons

      - name: Wait for upload completion
        run: |
          echo "‚è≥ Waiting 10 seconds to ensure upload is complete..."
          sleep 10
          echo "‚úÖ Upload wait complete"

  publish-posters:
    name: Publish Posters Pack
    if: ${{ github.event.inputs.publish_posters == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Upload to Thunderstore
        uses: GreenTF/upload-thunderstore-package@v4.3
        with:
          community: ${{ env.GAME_NAME }}
          namespace: ${{ env.NAMESPACE }}
          name: MoreBrutalLCPosters
          version: ${{ github.event.inputs.version }}
          description: "Contains all customized posters for MoreBrutalLethalCompanyPlus! MoreBrutalLethalCompanyPlus is required!"
          token: ${{ secrets.Automatic_Publish }}
          categories: |
            Asset Replacements
            Modpacks
          file: packs/BrutalLCPosters

      - name: Wait for upload completion
        run: |
          echo "‚è≥ Waiting 15 seconds to ensure upload is complete..."
          sleep 15
          echo "‚úÖ Upload wait complete"

  publish-logo:
    name: Publish Logo Pack
    if: ${{ github.event.inputs.publish_logo == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Upload to Thunderstore
        uses: GreenTF/upload-thunderstore-package@v4.3
        with:
          community: ${{ env.GAME_NAME }}
          namespace: ${{ env.NAMESPACE }}
          name: CustomLogoForMBLCP
          version: ${{ github.event.inputs.version }}
          description: "Replaces default Lethal Company logo with custom branding for MoreBrutalLethalCompanyPlus!"
          token: ${{ secrets.Automatic_Publish }}
          categories: |
            Asset Replacements
            Modpacks
          file: packs/CustomLogoForMBLCP

      - name: Wait for upload completion
        run: |
          echo "‚è≥ Waiting 15 seconds to ensure upload is complete..."
          sleep 15
          echo "‚úÖ Upload wait complete"

  publish-modpack:
    name: Publish MoreBrutalLethalCompanyPlus
    needs: [preparation, publish-main-core, publish-cosmetics, publish-moons, publish-posters, publish-logo]
    if: |
      always() &&
      github.event.inputs.publish_modpack == 'true' &&
      (needs.publish-main-core.result == 'success' || needs.publish-main-core.result == 'skipped') &&
      (needs.publish-cosmetics.result == 'success' || needs.publish-cosmetics.result == 'skipped') &&
      (needs.publish-moons.result == 'success' || needs.publish-moons.result == 'skipped') &&
      (needs.publish-posters.result == 'success' || needs.publish-posters.result == 'skipped') &&
      (needs.publish-logo.result == 'success' || needs.publish-logo.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update Emblem version
        run: |
          NEW_VERSION="v${{ github.event.inputs.version }}"
          CURRENT_VERSION=$(grep -A 1 "\[8\. Version Number\]" config/Darkbrewery.Emblem.cfg | grep "^Text = " | sed 's/Text = //')

          if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
            echo "‚úÖ Emblem version already correct: $CURRENT_VERSION"
          else
            echo "üîÑ Updating Emblem version: $CURRENT_VERSION ‚Üí $NEW_VERSION"
            sed -i "/\[8\. Version Number\]/,/^\[/ s|^Text = .*|Text = $NEW_VERSION|" config/Darkbrewery.Emblem.cfg
          fi

      - name: Update Terminal version
        run: |
          NEW_VERSION="${{ github.event.inputs.version }}"
          CONFIG_FILE="config/darmuh.TerminalStuff.cfg"

          # Extract current version from the MOREBRUTAL-XX.XX.XX pattern
          CURRENT_VERSION=$(grep "MOREBRUTAL-" "$CONFIG_FILE" | grep -oP 'MOREBRUTAL-\K[0-9]+\.[0-9]+\.[0-9]+' | head -1)

          if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
            echo "‚úÖ Terminal version already correct: $CURRENT_VERSION"
          else
            echo "üîÑ Updating Terminal version: $CURRENT_VERSION ‚Üí $NEW_VERSION"
            sed -i "s/MOREBRUTAL-${CURRENT_VERSION}/MOREBRUTAL-${NEW_VERSION}/g" "$CONFIG_FILE"
          fi

      - name: Disable BepInEx console
        run: |
          # Check current state
          CURRENT_STATE=$(grep -A 5 "\[Logging\.Console\]" config/BepInEx.cfg | grep "^Enabled = " | awk '{print $3}')

          if [ "$CURRENT_STATE" = "false" ]; then
            echo "‚úÖ BepInEx console already disabled"
          else
            echo "üîÑ Disabling BepInEx console (was: $CURRENT_STATE)"
            sed -i '/^\[Logging\.Console\]/,/^\[/ s/^Enabled = true/Enabled = false/' config/BepInEx.cfg
          fi

      - name: Copy configs to modpack folder
        run: |
          echo "üì¶ Copying config folder to modpack..."

          # Create BepInEx/config directory in modpack folder
          mkdir -p packs/MoreBrutalLethalCompany/BepInEx/config

          # Copy entire config folder contents
          cp -r config/* packs/MoreBrutalLethalCompany/BepInEx/config/

          # Count copied files
          COPIED_FILES=$(find packs/MoreBrutalLethalCompany/BepInEx/config -type f | wc -l)
          echo "‚úÖ Copied $COPIED_FILES config files to modpack"

          # Show structure for verification
          echo "üìÇ Modpack structure:"
          ls -la packs/MoreBrutalLethalCompany/
          echo "üìÇ Config folder (first 20 files):"
          ls -la packs/MoreBrutalLethalCompany/BepInEx/config/ | head -20

      - name: Upload to Thunderstore
        uses: GreenTF/upload-thunderstore-package@v4.3
        with:
          community: ${{ env.GAME_NAME }}
          namespace: ${{ env.NAMESPACE }}
          name: MoreBrutalLethalCompanyPlus
          version: ${{ github.event.inputs.version }}
          description: "[V73] Balanced modpack that makes game slightly harder and still enjoyable and still keeping it in vanilla style!"
          token: ${{ secrets.Automatic_Publish }}
          categories: |
            Mods
            Modpacks
          deps: ${{ needs.preparation.outputs.dependencies }}
          file: packs/MoreBrutalLethalCompany

      - name: Wait for upload completion
        run: |
          echo "‚è≥ Waiting 15 seconds to ensure upload is complete..."
          sleep 15
          echo "‚úÖ Upload wait complete"

      - name: Cleanup copied configs
        run: |
          echo "üßπ Cleaning up copied config folder..."

          # Remove the copied BepInEx folder from modpack
          rm -rf packs/MoreBrutalLethalCompany/BepInEx

          echo "‚úÖ Cleanup complete - configs removed from modpack folder"
          echo "üìÇ Modpack folder after cleanup:"
          ls -la packs/MoreBrutalLethalCompany/

  create-release:
    name: Create GitHub Release
    needs: [publish-modpack, publish-main-core, publish-cosmetics, publish-moons, publish-posters, publish-logo]
    if: |
      always() &&
      (needs.publish-modpack.result == 'success' ||
       needs.publish-main-core.result == 'success' ||
       needs.publish-cosmetics.result == 'success' ||
       needs.publish-moons.result == 'success' ||
       needs.publish-posters.result == 'success' ||
       needs.publish-logo.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.event.inputs.version }}
          release_name: "MoreBrutalLethalCompanyPlus v${{ github.event.inputs.version }}"
          body: |
            # MoreBrutalLethalCompanyPlus v${{ github.event.inputs.version }}

            ## üì¶ Published Packages

            ### Sub-packs (published first):
            - ${{ needs.publish-main-core.result == 'success' && '‚úÖ BrutalLCMain' || '‚è≠Ô∏è BrutalLCMain (skipped)' }}
            - ${{ needs.publish-cosmetics.result == 'success' && '‚úÖ Cosmetics Pack' || '‚è≠Ô∏è Cosmetics Pack (skipped)' }}
            - ${{ needs.publish-moons.result == 'success' && '‚úÖ Moons Pack' || '‚è≠Ô∏è Moons Pack (skipped)' }}
            - ${{ needs.publish-posters.result == 'success' && '‚úÖ Posters Pack' || '‚è≠Ô∏è Posters Pack (skipped)' }}
            - ${{ needs.publish-logo.result == 'success' && '‚úÖ Logo Pack' || '‚è≠Ô∏è Logo Pack (skipped)' }}

            ### Main modpack (published last):
            - ${{ needs.publish-modpack.result == 'success' && '‚úÖ MoreBrutalLethalCompanyPlus' || '‚è≠Ô∏è MoreBrutalLethalCompanyPlus (skipped)' }}

            ## üì• Download

            All packages are available on Thunderstore:
            - [MoreBrutalLethalCompanyPlus](https://thunderstore.io/c/lethal-company/p/seechela/MoreBrutalLethalCompanyPlus/)
            - [MoreBrutalLCMain](https://thunderstore.io/c/lethal-company/p/seechela/MoreBrutalLCMain/)
            - [MoreBrutalLCCosmetics](https://thunderstore.io/c/lethal-company/p/seechela/MoreBrutalLCCosmetics/)
            - [MoreBrutalLCMoons](https://thunderstore.io/c/lethal-company/p/seechela/MoreBrutalLCMoons/)
            - [MoreBrutalLCPosters](https://thunderstore.io/c/lethal-company/p/seechela/MoreBrutalLCPosters/)
            - [CustomLogoForMBLCP](https://thunderstore.io/c/lethal-company/p/seechela/CustomLogoForMBLCP/)

            ## üìù Changelog

            See [CHANGELOG.md](https://github.com/se3ya/MoreBrutalLC-Plus/blob/main/CHANGELOG.md) for detailed version history.

            ---

            **Experience the Company. Brutally.**
          draft: false
          prerelease: false
